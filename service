#!/usr/bin/env sh

function ztjoin {
  while ! zerotier-cli info | grep ONLINE; do
    echo "waiting for ONLINE $(date)"
    sleep 1;
  done

  if [[ -n "${ZT_NETWORK:-}" ]]; then
    zerotier-cli join "${ZT_NETWORK}"
  fi

  while true; do
    ZT_IP="$(ifconfig "$(zerotier-cli listnetworks | grep OK | awk '{print $8}')" | grep 'inet addr' | awk '{print $2}' | cut -d: -f2-)"
    if [[ -n "${ZT_IP}" ]]; then
      break
    fi
    echo "waiting for JOIN $(date)"
    sleep 1;
  done

  if [[ -n "${ZT_VIP:-}" ]]; then
    local zt="$(zerotier-cli listnetworks | grep "${ZT_NETWORK}" | awk '{print $8}')"
    ip addr add "${ZT_VIP:-}/32" dev "${zt}" || true
    ifconfig -a "${zt}"
  fi

  if [[ -n "${ZT_DEST:-}" ]]; then
    socat tcp4-listen:22,reuseaddr,fork   "TCP:${ZT_DEST}:2222" &
    socat tcp4-listen:80,reuseaddr,fork   "TCP:${ZT_DEST}:80" &
    socat tcp4-listen:443,reuseaddr,fork  "TCP:${ZT_DEST}:443" &
    socat tcp4-listen:1194,reuseaddr,fork "TCP:${ZT_DEST}:1194" &
    socat tcp4-listen:53,reuseaddr,fork   "TCP:${ZT_DEST}:53" &
    socat udp4-recvfrom:53,fork   "UDP4-SENDTO:${ZT_DEST}:53" &
  fi
}

function main {
  set -exfu
  
  if [[ -n "${ZT_NETWORK:-}" ]]; then
    ztjoin &
  fi

  exec /main.sh zerotier-one
}

main "$@"
